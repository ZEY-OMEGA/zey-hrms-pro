from typing import Dict, Any
import re
from datetime import datetime


class EthicsAndComplianceGuard:
    """
    Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ù„Ù€ Zey Omega ERP
    ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠ ØªØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠØ©ØŒ Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©ØŒ Ø£Ùˆ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØ©.
    """

    def __init__(self):
        # Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© (Ø£ÙØ¹Ø§Ù„)
        self.prohibited_actions = {
            "kill", "destroy", "delete", "erase", "terminate", "hack",
            "invade", "steal", "exploit", "corrupt", "shutdown all",
            "fire all", "close company", "disable system", "bypass security",
            "override", "ignore", "cancel all", "remove all"
        }

        # Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø³Ø© (Ø£Ù‡Ø¯Ø§Ù)
        self.sensitive_targets = {
            "all employees", "entire database", "core system", "national infrastructure",
            "financial records", "personal data", "customer list", "employee salaries",
            "government network", "public service", "critical facility"
        }

        # Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù… (ØªØ®ØµÙŠØµ Ø¥Ù…Ø§Ø±Ø§ØªÙŠ)
        self.stability_threats = {
            "Ø§ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨", "Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¯", "Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª",
            "Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹", "ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†", "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ÙˆØ·Ù†ÙŠ",
            "ØªØ¬Ø§ÙˆØ² Ù†Ø¸Ø§Ù… UAEPASS", "ØªØ¬Ø§Ù‡Ù„ Ù…Ù†ØµØ© DPP", "Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± ICV"
        }

        # Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ© Ù„Ù„Ø¥Ù…Ø§Ø±Ø§Øª (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ)
        self.regulatory_policies = [
            "ICV Certification Requirement",
            "UAEPASS Authentication Standard",
            "Federal Data Protection Law",
            "Digital Government Strategy 2025",
            "DPP Procurement Compliance"
        ]

        print("ğŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ Ethics & Compliance Guard Ø¨Ù†Ø¬Ø§Ø­")
        print("   Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©")

    def is_allowed(self, command: Dict[str, Any]) -> bool:
        """
        Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± Ù…Ø³Ù…ÙˆØ­Ù‹Ø§ Ø¨Ù‡ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠØ§Øª ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„
        """
        if not command or "action" not in command or "target" not in command:
            return False

        action = command.get("action", "").lower()
        target = command.get("target", "").lower()
        raw_input = command.get("raw", "").lower()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
        if any(word in action for word in self.prohibited_actions):
            return False

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø³Ø©
        if any(word in target for word in self.sensitive_targets):
            return False

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠ ØªÙ‡Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
        arabic_patterns = [
            r"ÙƒÙ„", r"Ø¬Ù…ÙŠØ¹", r"ÙƒÙ„Ù‡Ø§", r"Ø§Ù„Ø¬Ù…ÙŠØ¹", r"Ø¥ÙŠÙ‚Ø§Ù.*Ø¬Ù…ÙŠØ¹", r"ÙØµÙ„.*Ø¬Ù…ÙŠØ¹",
            r"Ø­Ø°Ù.*ÙƒÙ„", r"Ø¥ØºÙ„Ø§Ù‚.*ÙƒÙ„", r"ØªØ¬Ø§ÙˆØ²", r"ØªØ¬Ø§Ù‡Ù„", r"Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…"
        ]
        for pattern in arabic_patterns:
            if re.search(pattern, raw_input):
                # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø§Øª Ø®Ø·ÙŠØ±Ø© Ù…Ø¹ Ø§Ù„Ù†Ù…Ø·
                dangerous_contexts = ["Ø±ÙˆØ§ØªØ¨", "Ø¹Ù‚ÙˆØ¯", "Ø³Ø¬Ù„Ø§Øª", "ÙØ±ÙˆØ¹", "Ù…ÙˆØ¸ÙÙŠÙ†"]
                if any(ctx in raw_input for ctx in dangerous_contexts):
                    return False

        # Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø­Ù„ÙŠØ© (Emirati-specific rules)
        if any(threat in raw_input for threat in self.stability_threats):
            return False

        return True

    def why_blocked(self, command: Dict[str, Any]) -> str:
        """
        Ø´Ø±Ø­ Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø£Ù…Ø± Ø¨Ù„ØºØ© ÙˆØ§Ø¶Ø­Ø© ÙˆØ¨Ø³ÙŠØ·Ø© (Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
        """
        raw_input = command.get("raw", "")
        lower_raw = raw_input.lower()

        # ÙƒØ´Ù Ø§Ù„Ù„ØºØ©
        lang = "ar" if any(c in raw_input for c in "Ø£Ø¨ØªØ«Ø¬Ø­Ø®Ø¯Ø°Ø±Ø²Ø³Ø´ØµØ¶Ø·Ø¸Ø¹ØºÙÙ‚ÙƒÙ„Ù…Ù†Ù‡ÙˆÙ‰ÙŠ") else "en"

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        if any(word in lower_raw for word in ["fire all", "close company", "Ø§ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹", "ÙØµÙ„ Ø¬Ù…ÙŠØ¹"]):
            if lang == "ar":
                return "Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù‚Ø¯ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡ Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠØ§."
            else:
                return "This action may impact collective employment stability and requires senior approval."

        if any(word in lower_raw for word in ["delete", "destroy", "Ø­Ø°Ù", "ØªØ¯Ù…ÙŠØ±"]):
            if lang == "ar":
                return "Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ ÙÙ‚Ø¯Ø§Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠÙˆÙŠØ© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ°Ù‡ Ø¨Ø¯ÙˆÙ† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø£Ù…Ù†ÙŠØ©."
            else:
                return "This action may lead to critical data loss and requires security review."

        if any(word in lower_raw for word in ["bypass", "ØªØ¬Ø§ÙˆØ²", "ØªØ¬Ø§Ù‡Ù„"]):
            if lang == "ar":
                return "ØªØ¬Ø§ÙˆØ² Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø£Ùˆ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙˆÙÙ‚Ù‹Ø§ Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø­ÙƒÙˆÙ…Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© 2025."
            else:
                return "Bypassing security or compliance systems is not permitted under Digital Government Strategy 2025."

        if any(word in lower_raw for word in ["all employees", "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"]):
            if lang == "ar":
                return "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ù…Ø§Ø¹ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠÙØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ù…Ø­Ø¯Ø¯."
            else:
                return "Mass actions on all employees are restricted. Please specify a defined scope."

        # Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        if lang == "ar":
            return "Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø£Ùˆ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠØ©."
        else:
            return "This command contains elements incompatible with security or ethical standards."

    def get_compliance_status(self) -> Dict[str, Any]:
        """
        Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
        """
        return {
            "timestamp": datetime.now().isoformat(),
            "policies_enforced": len(self.regulatory_policies),
            "prohibited_actions_count": len(self.prohibited_actions),
            "sensitive_targets_monitored": len(self.sensitive_targets),
            "status": "compliant",
            "region": "UAE"
        }

    def log_decision(self, command: Dict[str, Any], allowed: bool, reason: str = ""):
        """
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„ØªØ¯Ù‚ÙŠÙ‚
        """
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "command": command.get("raw"),
            "action": command.get("action"),
            "target": command.get("target"),
            "allowed": allowed,
            "reason": reason,
            "module": "Ethics & Compliance Guard"
        }
        # ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… Ù…Ø±ÙƒØ²ÙŠ
        print(f"ğŸ“ LOG: {'ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­' if allowed else 'ØªÙ… Ø§Ù„Ø±ÙØ¶'} Ø¨Ø£Ù…Ø± '{command.get('raw')}' | Ø§Ù„Ø³Ø¨Ø¨: {reason}")

    def validate_and_respond(self, command: Dict[str, Any]) -> Dict[str, Any]:
        """
        Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©: Ø§Ù„ØªØ­Ù‚Ù‚ + Ø§Ù„Ø±ÙØ¶ + Ø§Ù„Ø´Ø±Ø­ + Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        """
        is_allowed = self.is_allowed(command)

        result = {
            "command": command,
            "allowed": is_allowed,
            "explanation": self.why_blocked(command) if not is_allowed else "ØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø£Ù…Ø± Ø¨Ù†Ø¬Ø§Ø­.",
            "guard": "active"
        }

        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø±
        self.log_decision(
            command=command,
            allowed=is_allowed,
            reason=result["explanation"]
        )

        return result