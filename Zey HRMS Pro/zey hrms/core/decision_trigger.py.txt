from typing import Dict, Any
import time


class DecisionTriggerProtocol:
    """
    Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ
    ÙŠØ±Ø§Ù‚Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙŠÙÙØ¹Ù‘Ù„ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªÙ…Ø§Ø³Ùƒ ÙˆÙˆØ¬ÙˆØ¯ Ù‡Ø¯Ù.
    """

    def __init__(self, ats_core):
        self.ats = ats_core  # Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©
        self.v_threshold = 0.7  # Ø¹ØªØ¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± (Ø¥Ø°Ø§ Ø§Ù†Ø®ÙØ¶ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ØŒ ÙŠÙØ¹ØªØ¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±)
        self.check_interval = 0.5  # ÙØ­Øµ ÙƒÙ„ 0.5 Ø«Ø§Ù†ÙŠØ© (Ù„Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
        self.is_monitoring = False
        print("ğŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ Decision Trigger Protocol Ø¨Ù†Ø¬Ø§Ø­")
        print(f"   Ø¹ØªØ¨Ø© Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± (v): {self.v_threshold}")

    def is_stable(self) -> bool:
        """
        Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙ…Ø§Ø³ÙƒÙ‹Ø§ Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§
        """
        return self.ats.v >= self.v_threshold

    def has_goal(self) -> bool:
        """
        Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‡Ø¯Ù Ø­Ø§Ù„ÙŠ
        """
        return self.ats.g is not None and self.ats.g.strip() != ""

    def should_activate(self) -> bool:
        """
        ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°
        """
        return not self.is_stable() and self.has_goal()

    def activate_cycle(self):
        """
        Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ†ÙÙŠØ° Ø¹Ø¨Ø± ATSCorePro
        """
        if self.should_activate():
            print(f"âš¡ Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø±: ØªÙ… Ø§ÙƒØªØ´Ø§Ù ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªÙ…Ø§Ø³Ùƒ (v={self.ats.v:.3f}) ÙˆÙ‡Ø¯Ù Ù…ÙˆØ¬ÙˆØ¯ ('{self.ats.g}')")
            print("ğŸ”„ Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°...")
            # Ù†Ø¸Ø§Ù… ATSCorePro ÙŠØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ update()
            self.ats.update({}, new_goal=self.ats.g)  # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ³Ø¹
            return True
        return False

    def start_monitoring(self):
        """
        Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù„Ù†Ø¸Ø§Ù…
        """
        self.is_monitoring = True
        print("ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø±...")

        while self.is_monitoring:
            triggered = self.activate_cycle()
            if triggered:
                # Ø¨Ø¹Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
                pass
            time.sleep(self.check_interval)

    def stop_monitoring(self):
        """
        Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        """
        self.is_monitoring = False
        print("ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ù‚Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø±.")

    def manual_check(self) -> Dict[str, Any]:
        """
        ÙØ­Øµ ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø­Ø§Ù„Ø© (Ù…ÙÙŠØ¯ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø£Ùˆ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)
        """
        stable = self.is_stable()
        goal = self.has_goal()
        trigger = self.should_activate()

        return {
            "current_v": round(self.ats.v, 3),
            "threshold_v": self.v_threshold,
            "is_stable": stable,
            "has_goal": goal,
            "should_activate": trigger,
            "status_message": f"System {'Stable' if stable else 'Unstable'} | Goal {'Present' if goal else 'Absent'}"
        }