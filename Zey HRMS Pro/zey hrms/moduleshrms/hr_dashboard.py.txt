
from flask import Flask, render_template, jsonify
from modules.hrms.attendance_engine import AttendanceEngine
from modules.hrms.biometric_interface import BiometricInterface
import threading
import time


app = Flask(__name__, template_folder='../../templates')


biometric = BiometricInterface()
attendance = AttendanceEngine()
current_report = None


def background_updater():
    global current_report
    while True:
        data = biometric.sync_all_devices("2025-09-15")
        if data["success"]:
            current_report = attendance.generate_daily_report(data["data"], "2025-09-15")
        time.sleep(30)


@app.route('/hr')
def hr_dashboard():
    return render_template('hr_dashboard.html', lang='ar')


@app.route('/api/hr/status')
def get_hr_status():
    if current_report:
        return jsonify(current_report)
    return jsonify({"error": "No data available"})


if __name__ == "__main__":
    thread = threading.Thread(target=background_updater, daemon=True)
    thread.start()
    app.run(port=5001, debug=False)
```