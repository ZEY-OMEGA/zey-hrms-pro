
from datetime import datetime, date
from typing import Dict, Any, List
from modules.hrms.biometric_interface import BiometricInterface
from modules.hrms.attendance_engine import AttendanceEngine
from modules.hrms.payroll_integrator import PayrollIntegrator


class AttendanceService:
    """
    Ø®Ø¯Ù…Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    """

    def __init__(self):
        self.biometric = BiometricInterface()
        self.engine = AttendanceEngine()
        self.payroll = PayrollIntegrator()
        print("ğŸŸ¢ ØªÙ… ØªØ´ØºÙŠÙ„ Ø®Ø¯Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±")

    def process_daily_attendance(self, target_date: str) -> Dict[str, Any]:
        """
        Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯: Ù…Ø²Ø§Ù…Ù†Ø© â†’ ØªØ­Ù„ÙŠÙ„ â†’ Ø±Ø¨Ø· Ø¨Ø§Ù„Ø±ÙˆØ§ØªØ¨
        """
        try:
            # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
            sync_result = self.biometric.sync_all_devices(target_date)
            if not sync_result["success"]:
                return {"error": "ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©", "details": sync_result}

            raw_data = sync_result["data"]

            # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±
            daily_report = self.engine.generate_daily_report(raw_data, target_date)

            # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø±Ø¨Ø· Ø¨Ø§Ù„Ø±ÙˆØ§ØªØ¨
            payroll_data = self.payroll.generate_payroll_data(daily_report)

            # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            result = {
                "status": "success",
                "timestamp": datetime.now().isoformat(),
                "date_processed": target_date,
                "attendance_report": daily_report,
                "payroll_deductions": payroll_data
            }

            print(f"âœ… ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… {target_date} Ø¨Ù†Ø¬Ø§Ø­")
            return result

        except Exception as e:
            error_result = {
                "status": "error",
                "timestamp": datetime.now().isoformat(),
                "error_message": str(e),
                "date_attempted": target_date
            }
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±: {str(e)}")
            return error_result

    def get_employee_summary(self, employee_id: str, date_range: tuple) -> Dict[str, Any]:
        """
        Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù Ø®Ù„Ø§Ù„ ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ©
        """
        # Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø³ØªÙØ­Ø³Ù† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª
        return {
            "employee_id": employee_id,
            "name": "Ù…ÙˆØ¸Ù ÙˆÙ‡Ù…ÙŠ",
            "period": f"{date_range[0]} Ø¥Ù„Ù‰ {date_range[1]}",
            "total_days": 20,
            "present_days": 18,
            "absent_days": 1,
            "late_days": 1,
            "total_lateness_minutes": 75
        }
```